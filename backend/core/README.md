# Bloom Backend Services

This package is a [NestJS application](https://docs.nestjs.com/) that provides a core set of backend services via REST API endpoints to apps using the Bloom Housing framework. Information is stored in a Postgres database, accessed via [TypeORM](https://typeorm.io/).

## OpenAPI Documentation

OpenAPI (fka Swagger) documentation is automatically generated by the server at `http://localhost:3100/docs/` for a standard local development environment. A raw JSON version of the schema is also available at `/docs-json/`, suitable for API client code generation or other code-based consumers.

## Getting Started for Developers

The following steps should provide a working local environement for development purposes:

### Setting up your local environment variables

Operational configuration the service is read from environment variables. Copy `.env.template` to `.env` and edit the settings specific to your development environment. Make sure the Database URL and Test Database URL match your Postgres configuration.

### Installing Postgres

You can install Postgres using Homebrew with the following command: `brew install postgresql`.

### Setting up a Database

There are two databases used in this project: `bloom` and `bloom_test`. First is used every time you are starting a project with `yarn dev` and second one is only used in end-to-end tests. Corresponding TypeORM configs are defined in `ormconfig.ts` and `ormconfig.test.ts`.
If you are just starting to work with the projects it's best to simply run:

```shell script
yarn && yarn db:reseed
```

that will create `bloom` DB for you, migrate it to the latest schema and seed with appropriate dev data. If running the reseed command requires that you input a password for Postgres, set the following environment variables: `PGUSER` to postgres and `PGPASSWORD` to the default password you inputted for the postgres user during Postgres installation.

Dropping the DB:

```shell script
yarn db:drop
```

Creating the DB:

```shell script
yarn db:create
```

Seeding the DB:

```shell script
yarn db:seed
```

Generating a new migration:

```shell script
yarn db:migration:generate
```

Applying migrations:

```shell script
yarn db:migration:run
```

### Installing Redis

You can install Redis using Homebrew with the following command: `brew install redis`.

To start Redis:
`redis-server`.

To have launch Redis as background service and restart at login:
`brew services start redis`.

Test if Redis is working:
`redis-cli ping`

### Debugging

You can connect a debugger to the backend by starting the backend server with `yarn debug`.

To connect to it from VS Code, add a configuration to launch.json that looks like

```shell script
{
  "name": "Attach to Backend",
  "port": 9229,
  "request": "attach",
  "skipFiles": [
    "<node_internals>/**"
  ],
  "type": "node",
  "restart": true
},
```

### Running Tests

End-to-end tests:

```shell script
yarn test:e2e:local
```

Unit tests:

```shell script
yarn test
```

### Translations

Backend keeps translations for email related content in the DB in table `translations` .
There is an endpoint `/translations` exposing CRUD operations on this table (admin only).
Translations are defined for each county code and language pair e.g. (Alameda, en). To modify a particular
translation pair:

1. Fetch `GET /translations` and list all the translations
2. Find an ID of a pair that interest you
3. Use `PUT /translations/:translationId` to modify it's content
